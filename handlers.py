import json
from typing import Union
from aiogram import Router, F, Bot
from aiogram.filters import Command
from aiogram.types import Message, CallbackQuery, InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup

from database import (
    add_user, get_user, create_ticket, get_ticket,
    update_ticket_status, is_admin, is_ceo, get_all_admins,
    add_admin
)
from keyboards import (
    get_contact_keyboard, get_ticket_actions_keyboard,
    get_admin_keyboard, get_ticket_priority_keyboard,
    get_ticket_close_keyboard
)
from messages import MessageManager
from notifications import NotificationManager

# –°–æ–∑–¥–∞–µ–º —Ä–æ—É—Ç–µ—Ä
router = Router()

# –ò–º–ø–æ—Ä—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–π
from states import UserRegistration, TicketResponse, AdminManagement

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤
message_manager = MessageManager()
notification_manager: NotificationManager = None

def init_managers(bot: Bot):
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤"""
    global notification_manager
    notification_manager = NotificationManager(bot)

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
@router.message(Command("start"))
async def cmd_start(message: Message, state: FSMContext):
    from init_data import check_admin_role
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    role = await check_admin_role(message.from_user.id)
    
    if role == "CEO":
        keyboard = InlineKeyboardMarkup(
            inline_keyboard=[
                [
                    InlineKeyboardButton(
                        text="–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è",
                        callback_data="admin_panel"
                    )
                ],
                [
                    InlineKeyboardButton(
                        text="–î–æ–±–∞–≤–∏—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞",
                        callback_data="add_admin"
                    )
                ]
            ]
        )
        await message.answer(
            f"–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, —Ä—É–∫–æ–≤–æ–¥–∏—Ç–µ–ª—å!\n\n"
            f"–í—ã –∏–º–µ–µ—Ç–µ –ø–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é —Å–∏—Å—Ç–µ–º–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏.\n"
            f"–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–ª—è:\n"
            f"‚Ä¢ –ü—Ä–æ—Å–º–æ—Ç—Ä–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏\n"
            f"‚Ä¢ –£–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º–∏\n"
            f"‚Ä¢ –†–∞–±–æ—Ç—ã —Å —Ç–∏–∫–µ—Ç–∞–º–∏",
            reply_markup=keyboard
        )
        return
    elif role == "admin":
        keyboard = InlineKeyboardMarkup(
            inline_keyboard=[
                [
                    InlineKeyboardButton(
                        text="–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è",
                        callback_data="admin_panel"
                    )
                ]
            ]
        )
        await message.answer(
            f"–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä!\n\n"
            f"–í—ã –º–æ–∂–µ—Ç–µ:\n"
            f"‚Ä¢ –ü—Ä–æ—Å–º–∞—Ç—Ä–∏–≤–∞—Ç—å —Ç–∏–∫–µ—Ç—ã\n"
            f"‚Ä¢ –û—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –æ–±—Ä–∞—â–µ–Ω–∏—è\n"
            f"‚Ä¢ –í–∏–¥–µ—Ç—å —Å–≤–æ—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É",
            reply_markup=keyboard
        )
        return
    
    # –î–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    user = await get_user(message.from_user.id)
    if not user:
        await message.answer(
            "–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —Å–ª—É–∂–±—É –ø–æ–¥–¥–µ—Ä–∂–∫–∏! –î–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, "
            "–ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å—Ç–µ —Å–≤–æ–π –∫–æ–Ω—Ç–∞–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞.",
            reply_markup=get_contact_keyboard()
        )
        await state.set_state(UserRegistration.waiting_for_contact)
    else:
        await message.answer(
            "–í—ã —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã. –û—Ç–ø—Ä–∞–≤—å—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å —Ç–∏–∫–µ—Ç."
        )

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–æ–Ω—Ç–∞–∫—Ç–∞
@router.message(UserRegistration.waiting_for_contact, F.contact)
async def process_contact(message: Message, state: FSMContext):
    contact = message.contact
    
    success = await add_user(
        user_id=message.from_user.id,
        username=message.from_user.username or "No username",
        full_name=message.from_user.first_name,
        phone=contact.phone_number
    )
    
    if success:
        await message.answer(
            "–°–ø–∞—Å–∏–±–æ –∑–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é! –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–≤–æ–π –≤–æ–ø—Ä–æ—Å.",
            reply_markup=None
        )
        await state.clear()
    else:
        await message.answer(
            "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
        )

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–æ–≤–æ–≥–æ –∞–¥–º–∏–Ω–∞
@router.message(AdminManagement.waiting_for_admin_id)
async def process_new_admin_id(message: Message, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ ID –Ω–æ–≤–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞"""
    if not await is_ceo(message.from_user.id):
        await message.answer("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ CEO")
        await state.clear()
        return

    try:
        admin_id = int(message.text.strip())
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —É–∂–µ –∞–¥–º–∏–Ω–æ–º
        if await is_admin(admin_id):
            await message.answer("–≠—Ç–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ —è–≤–ª—è–µ—Ç—Å—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º!")
            await state.clear()
            return
            
        success = await add_admin(
            admin_id=admin_id,
            username="Admin",  # –ë—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–æ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏
            role="admin"
        )
        
        if success:
            await message.answer(
                f"‚úÖ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä (ID: {admin_id}) —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!\n"
                f"–ü–æ–ø—Ä–æ—Å–∏—Ç–µ –Ω–æ–≤–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –Ω–∞–ø–∏—Å–∞—Ç—å /start –±–æ—Ç—É –¥–ª—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏."
            )
        else:
            await message.answer("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.")
    except ValueError:
        await message.answer("‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π ID. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —á–∏—Å–ª–æ–≤–æ–π ID.")
    
    await state.clear()

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ callback –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∞
@router.callback_query(lambda c: c.data == "add_admin")
async def process_add_admin_button(callback: CallbackQuery, state: FSMContext):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∞–¥–º–∏–Ω–∞"""
    if not await is_ceo(callback.from_user.id):
        await callback.answer("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ CEO")
        return

    await callback.message.answer(
        "–û—Ç–ø—Ä–∞–≤—å—Ç–µ Telegram ID –Ω–æ–≤–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞.\n"
        "ID –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å —á–∏—Å–ª–æ–º, –Ω–∞–ø—Ä–∏–º–µ—Ä: 123456789"
    )
    await state.set_state(AdminManagement.waiting_for_admin_id)
    await callback.answer()

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∏–∫–µ—Ç–∞
@router.message(F.content_type.in_({'text', 'photo', 'video', 'document', 'voice'}), F.chat.type == "private")
async def handle_message(message: Message, state: FSMContext):
    """
    –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∏–∫–µ—Ç–æ–≤
    """
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –∫–∞–∫–æ–≥–æ-–ª–∏–±–æ –¥–µ–π—Å—Ç–≤–∏—è
    current_state = await state.get_state()
    if current_state is not None:
        # –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ –∫–∞–∫–æ–º-—Ç–æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –æ–±—Ä–∞–±–æ—Ç–∫—É
        return

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å –∞–¥–º–∏–Ω–æ–º
    if await is_admin(message.from_user.id):
        # –î–ª—è –∞–¥–º–∏–Ω–æ–≤ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Ç–æ–º, —á—Ç–æ –æ–Ω–∏ –Ω–µ –º–æ–≥—É—Ç —Å–æ–∑–¥–∞–≤–∞—Ç—å —Ç–∏–∫–µ—Ç—ã
        await message.answer(
            "–í—ã —è–≤–ª—è–µ—Ç–µ—Å—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –∏ –Ω–µ –º–æ–∂–µ—Ç–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å —Ç–∏–∫–µ—Ç—ã. "
            "–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É /admin –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ –ø–∞–Ω–µ–ª–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è."
        )
        return

    user = await get_user(message.from_user.id)
    
    if not user:
        await message.answer(
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Å–Ω–∞—á–∞–ª–∞ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å —Å –ø–æ–º–æ—â—å—é –∫–æ–º–∞–Ω–¥—ã /start"
        )
        return

    # –°–µ—Ä–∏–∞–ª–∏–∑—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    message_data = message_manager.serialize_message(message)
    
    # –°–æ–∑–¥–∞–µ–º —Ç–∏–∫–µ—Ç
    ticket_id = await create_ticket(
        user_id=message.from_user.id,
        message_data=message_data
    )
    
    if ticket_id:
        # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É –¥–ª—è –∞–¥–º–∏–Ω–æ–≤
        keyboard = get_ticket_actions_keyboard(ticket_id)
        
        # –ü–æ–ª—É—á–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∞–¥–º–∏–Ω–æ–≤
        admins = await get_all_admins()
        admin_ids = [admin[1] for admin in admins]  # admin_id –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤–æ –≤—Ç–æ—Ä–æ–º —Å—Ç–æ–ª–±—Ü–µ
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        user_name = message.from_user.username or message.from_user.first_name
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        await notification_manager.notify_ticket_created(
            ticket_id=ticket_id,
            user_name=user_name,
            admin_ids=admin_ids,
            keyboard=keyboard
        )
        
        await message.answer(
            f"–í–∞—à —Ç–∏–∫–µ—Ç #{ticket_id} —Å–æ–∑–¥–∞–Ω. –ú—ã –æ—Ç–≤–µ—Ç–∏–º –≤–∞–º –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è."
        )
    else:
        await message.answer(
            "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç–∏–∫–µ—Ç–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
        )

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ç–∏–∫–µ—Ç–∞
@router.callback_query(lambda c: c.data.startswith('view_ticket:'))
async def process_ticket_view(callback: CallbackQuery):
    if not await is_admin(callback.from_user.id):
        await callback.answer("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞")
        return

    ticket_id = int(callback.data.split(':')[1])
    ticket = await get_ticket(ticket_id)
    
    if not ticket:
        await callback.answer("–¢–∏–∫–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω")
        return
    
    # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
    user = await get_user(ticket[1])  # ticket[1] —ç—Ç–æ user_id
    message_data = json.loads(ticket[9]) if ticket[9] else {}  # ticket[9] —ç—Ç–æ message_data
    
    # –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
    text = (
        f"üìã –¢–∏–∫–µ—Ç #{ticket_id}\n"
        f"–û—Ç: {user[3]}\n"  # user[3] —ç—Ç–æ full_name
        f"–°—Ç–∞—Ç—É—Å: {ticket[2]}\n"  # ticket[2] —ç—Ç–æ status
        f"–°–æ–∑–¥–∞–Ω: {ticket[4]}\n\n"  # ticket[4] —ç—Ç–æ created_at
    )

    # –î–æ–±–∞–≤–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å–æ–æ–±—â–µ–Ω–∏—è
    if message_data.get('text'):
        text += f"–°–æ–æ–±—â–µ–Ω–∏–µ: {message_data['text']}\n"
    
    # –°–æ–∑–¥–∞–µ–º –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –∫–Ω–æ–ø–∫–æ–π "–í–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É"
    keyboard = InlineKeyboardMarkup(
        inline_keyboard=[
            [
                InlineKeyboardButton(
                    text="–í–∑—è—Ç—å –≤ —Ä–∞–±–æ—Ç—É",
                    callback_data=f"take_ticket:{ticket_id}"
                )
            ]
        ]
    )

    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –º–µ–¥–∏–∞—Ñ–∞–π–ª, –µ—Å–ª–∏ –µ—Å—Ç—å
    if message_data.get('media_type') and message_data.get('media_id'):
        media_type = message_data['media_type']
        media_id = message_data['media_id']
        caption = text[:1024]  # –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –Ω–∞ –¥–ª–∏–Ω—É –ø–æ–¥–ø–∏—Å–∏

        if media_type == 'photo':
            await callback.message.answer_photo(media_id, caption=caption, reply_markup=keyboard)
        elif media_type == 'video':
            await callback.message.answer_video(media_id, caption=caption, reply_markup=keyboard)
        elif media_type == 'document':
            await callback.message.answer_document(media_id, caption=caption, reply_markup=keyboard)
        elif media_type == 'voice':
            await callback.message.answer_voice(media_id, caption=caption, reply_markup=keyboard)
    else:
        # –ï—Å–ª–∏ –Ω–µ—Ç –º–µ–¥–∏–∞—Ñ–∞–π–ª–∞, –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç
        await callback.message.answer(text, reply_markup=keyboard)

    await callback.answer()

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –≤–∑—è—Ç–∏—è —Ç–∏–∫–µ—Ç–∞ –≤ —Ä–∞–±–æ—Ç—É
@router.callback_query(lambda c: c.data.startswith('take_ticket:'))
async def process_ticket_taken(callback: CallbackQuery):
    if not await is_admin(callback.from_user.id):
        await callback.answer("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞")
        return

    ticket_id = int(callback.data.split(':')[1])
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≤–∑—è—Ç –ª–∏ —É–∂–µ —Ç–∏–∫–µ—Ç
    ticket = await get_ticket(ticket_id)
    if ticket[2] == 'in_progress':  # ticket[2] —ç—Ç–æ status
        await callback.answer("–≠—Ç–æ—Ç —Ç–∏–∫–µ—Ç —É–∂–µ –≤–∑—è—Ç –≤ —Ä–∞–±–æ—Ç—É –¥—Ä—É–≥–∏–º –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º")
        return
    
    # –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Ç–∏–∫–µ—Ç–∞
    await update_ticket_status(
        ticket_id=ticket_id,
        status='in_progress',
        admin_id=callback.from_user.id
    )
    
    # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
    user = await get_user(ticket[1])  # ticket[1] —ç—Ç–æ user_id
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    await notification_manager.notify_ticket_taken(
        ticket_id=ticket_id,
        admin_username=callback.from_user.username
    )
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    try:
        await callback.bot.send_message(
            chat_id=ticket[1],  # user_id
            text=f"–í–∞—à —Ç–∏–∫–µ—Ç #{ticket_id} –≤–∑—è—Ç –≤ –æ–±—Ä–∞–±–æ—Ç–∫—É —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–º –ø–æ–¥–¥–µ—Ä–∂–∫–∏"
        )
    except Exception as e:
        print(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é: {e}")
    
    # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —Ç–∏–∫–µ—Ç–æ–º
    keyboard = InlineKeyboardMarkup(
        inline_keyboard=[
            [
                InlineKeyboardButton(
                    text="–û—Ç–≤–µ—Ç–∏—Ç—å",
                    callback_data=f"reply:{ticket_id}"
                ),
                InlineKeyboardButton(
                    text="–ó–∞–∫—Ä—ã—Ç—å —Ç–∏–∫–µ—Ç",
                    callback_data=f"close:{ticket_id}"
                )
            ]
        ]
    )
    
    await callback.message.edit_reply_markup(reply_markup=keyboard)
    await callback.answer("–¢–∏–∫–µ—Ç –≤–∑—è—Ç –≤ —Ä–∞–±–æ—Ç—É")

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ —Ç–∏–∫–µ—Ç
@router.callback_query(lambda c: c.data.startswith('reply:'))
async def process_reply_start(callback: CallbackQuery, state: FSMContext):
    if not await is_admin(callback.from_user.id):
        await callback.answer("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞")
        return

    ticket_id = int(callback.data.split(':')[1])
    ticket = await get_ticket(ticket_id)
    
    if not ticket:
        await callback.answer("–¢–∏–∫–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω")
        return
    
    if ticket[2] != 'in_progress' or ticket[3] != callback.from_user.id:  # status –∏ assigned_admin_id
        await callback.answer("–≠—Ç–æ—Ç —Ç–∏–∫–µ—Ç –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –≤–∞—à–µ–π —Ä–∞–±–æ—Ç–µ")
        return
    
    await state.set_state(TicketResponse.waiting_for_response)
    await state.update_data(ticket_id=ticket_id)
    
    await callback.message.answer(
        "–û—Ç–ø—Ä–∞–≤—å—Ç–µ –≤–∞—à –æ—Ç–≤–µ—Ç –Ω–∞ —Ç–∏–∫–µ—Ç. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è —Ç–µ–∫—Å—Ç, —Ñ–æ—Ç–æ, –≤–∏–¥–µ–æ –∏ –¥–æ–∫—É–º–µ–Ω—Ç—ã."
    )
    await callback.answer()

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–≤–µ—Ç–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
@router.message(TicketResponse.waiting_for_response)
async def process_admin_response(message: Message, state: FSMContext):
    data = await state.get_data()
    ticket_id = data.get('ticket_id')
    
    if not ticket_id:
        await message.answer("–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –Ω–∞—á–∞—Ç—å –æ—Ç–≤–µ—Ç –∑–∞–Ω–æ–≤–æ.")
        await state.clear()
        return
    
    ticket = await get_ticket(ticket_id)
    if not ticket:
        await message.answer("–¢–∏–∫–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω")
        await state.clear()
        return
    
    try:
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –æ—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
        if message.text:
            await message.bot.send_message(
                chat_id=ticket[1],  # user_id
                text=f"–û—Ç–≤–µ—Ç –Ω–∞ –≤–∞—à —Ç–∏–∫–µ—Ç #{ticket_id}:\n{message.text}\n\n–° —É–≤–∞–∂–µ–Ω–∏–µ–º,\n–°–ª—É–∂–±–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏"
            )
        elif message.photo:
            await message.bot.send_photo(
                chat_id=ticket[1],
                photo=message.photo[-1].file_id,
                caption=f"–û—Ç–≤–µ—Ç –Ω–∞ –≤–∞—à —Ç–∏–∫–µ—Ç #{ticket_id}\n\n–° —É–≤–∞–∂–µ–Ω–∏–µ–º,\n–°–ª—É–∂–±–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏"
            )
        elif message.video:
            await message.bot.send_video(
                chat_id=ticket[1],
                video=message.video.file_id,
                caption=f"–û—Ç–≤–µ—Ç –Ω–∞ –≤–∞—à —Ç–∏–∫–µ—Ç #{ticket_id}\n\n–° —É–≤–∞–∂–µ–Ω–∏–µ–º,\n–°–ª—É–∂–±–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏"
            )
        elif message.document:
            await message.bot.send_document(
                chat_id=ticket[1],
                document=message.document.file_id,
                caption=f"–û—Ç–≤–µ—Ç –Ω–∞ –≤–∞—à —Ç–∏–∫–µ—Ç #{ticket_id}\n\n–° —É–≤–∞–∂–µ–Ω–∏–µ–º,\n–°–ª—É–∂–±–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏"
            )
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø—É
        await notification_manager.notify_ticket_answered(
            ticket_id=ticket_id,
            admin_username=message.from_user.username
        )
        
        await message.answer("–í–∞—à –æ—Ç–≤–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é")
    except Exception as e:
        await message.answer(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –æ—Ç–≤–µ—Ç–∞: {e}")
    
    await state.clear()

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∑–∞–∫—Ä—ã—Ç–∏—è —Ç–∏–∫–µ—Ç–∞
@router.callback_query(lambda c: c.data.startswith('close:'))
async def process_ticket_close(callback: CallbackQuery):
    if not await is_admin(callback.from_user.id):
        await callback.answer("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞")
        return

    ticket_id = int(callback.data.split(':')[1])
    ticket = await get_ticket(ticket_id)
    
    if not ticket:
        await callback.answer("–¢–∏–∫–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω")
        return
    
    if ticket[2] != 'in_progress' or ticket[3] != callback.from_user.id:
        await callback.answer("–≠—Ç–æ—Ç —Ç–∏–∫–µ—Ç –Ω–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –≤–∞—à–µ–π —Ä–∞–±–æ—Ç–µ")
        return
    
    # –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ç–∏–∫–µ—Ç
    await update_ticket_status(
        ticket_id=ticket_id,
        status='closed',
        admin_id=callback.from_user.id
    )
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    try:
        await callback.bot.send_message(
            chat_id=ticket[1],  # user_id
            text=f"–í–∞—à —Ç–∏–∫–µ—Ç #{ticket_id} –±—ã–ª –∑–∞–∫—Ä—ã—Ç. –°–ø–∞—Å–∏–±–æ –∑–∞ –æ–±—Ä–∞—â–µ–Ω–∏–µ!"
        )
    except Exception as e:
        print(f"–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é: {e}")
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ –≥—Ä—É–ø–ø—É
    await notification_manager.notify_ticket_closed(
        ticket_id=ticket_id,
        closed_by=f"@{callback.from_user.username}"
    )
    
    # –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
    await callback.message.edit_text(
        f"–¢–∏–∫–µ—Ç #{ticket_id} –∑–∞–∫—Ä—ã—Ç.",
        reply_markup=None
    )
    
    await callback.answer("–¢–∏–∫–µ—Ç —É—Å–ø–µ—à–Ω–æ –∑–∞–∫—Ä—ã—Ç")

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –º–µ–Ω—é —ç–∫—Å–ø–æ—Ä—Ç–∞
@router.callback_query(lambda c: c.data == "export_menu")
async def process_export_menu(callback: CallbackQuery):
    if not await is_ceo(callback.from_user.id):
        await callback.answer("–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ CEO")
        return

    keyboard = InlineKeyboardMarkup(
        inline_keyboard=[
            [
                InlineKeyboardButton(
                    text="–ó–∞ –¥–µ–Ω—å",
                    callback_data="export:day"
                ),
                InlineKeyboardButton(
                    text="–ó–∞ –Ω–µ–¥–µ–ª—é",
                    callback_data="export:week"
                ),
                InlineKeyboardButton(
                    text="–ó–∞ –º–µ—Å—è—Ü",
                    callback_data="export:month"
                )
            ],
            [
                InlineKeyboardButton(
                    text="¬´ –ù–∞–∑–∞–¥",
                    callback_data="admin_panel"
                )
            ]
        ]
    )
    
    await callback.message.edit_text(
        "–í—ã–±–µ—Ä–∏—Ç–µ –ø–µ—Ä–∏–æ–¥ –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö:",
        reply_markup=keyboard
    )
    await callback.answer()

# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /admin –∏ –∫–Ω–æ–ø–∫–∏ "–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è"
@router.message(Command("admin"))
@router.callback_query(lambda c: c.data == "admin_panel")
async def cmd_admin(event: Union[Message, CallbackQuery]):
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø —Å–æ–±—ã—Ç–∏—è –∏ –ø–æ–ª—É—á–∞–µ–º –Ω—É–∂–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    if isinstance(event, Message):
        user_id = event.from_user.id
        reply_method = event.answer
    else:  # CallbackQuery
        user_id = event.from_user.id
        reply_method = event.message.answer
        await event.answer()  # –£–±–∏—Ä–∞–µ–º —á–∞—Å–∏–∫–∏ —Å –∫–Ω–æ–ø–∫–∏

    if not await is_admin(user_id):
        await reply_method("–£ –≤–∞—Å –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–∞ –∫ –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏.")
        return

    is_ceo_user = await is_ceo(user_id)
    keyboard = get_admin_keyboard(is_ceo=is_ceo_user)
    
    await reply_method(
        "–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:",
        reply_markup=keyboard
    )

def register_all_handlers(dp: Router):
    """–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤—Å–µ—Ö –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤"""
    dp.include_router(router)